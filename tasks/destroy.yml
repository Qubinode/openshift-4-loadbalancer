---
- name: Stop and disable {{ lb_name }}.service
  systemd:
    name: "{{ lb_name }}.service"
    enabled: false
    state: stopped
  ignore_errors: true

- name: Remove OpenShift 4 Loadbalancer SystemD service
  file:
    path: "/etc/systemd/system/{{ lb_name }}.service"
    state: absent

- name: checking if podman containers is running
  shell: "podman container list -a --format {% raw %} 'table {{.Names}} {{.ID}}' {% endraw %}|awk '/openshift-4-loadbalancer/ {print $2}'"
  register: running_containers
  become: yes

- name: get uuid for {{ lb_name }} container
  shell: podman ps -a | awk '/{{ lb_name }}/ {print $1}'
  register: container_uuid
  ignore_errors: yes

- name: stop running containers
  shell: "podman stop {{ item }}"
  become: yes
  with_items: "{{ running_containers.stdout_lines }}"
  when: running_containers.stdout != ""

- name: delete {{ lb_name }} container
  #shell: "podman rm {{ item }}"
  command: podman container rm --force --storage {{ item }}
  when: running_containers.stdout != ""
  with_items: "{{ running_containers.stdout_lines }}"
  become: yes

- name: ensure {{ lb_name }} container is removed
  shell: "podman rm -f --storage {{ container_uuid.stdout }}"
  ignore_errors: no
  become: yes
  when: container_uuid is defined and container_uuid.stdout != ''
